# Wilo‑ERP — Mini ERP (НСИ, Бюджет, Калькуляции)

## Что это за система (как она устроена сейчас)
Wilo-ERP — это «мини-ERP» на Python + SQLite + (судя по прежним чатам) Streamlit-UI, которая замыкает цикл: загрузка первички из 1С/Excel → нормализация → расчёты бюджета (материалы/операции/тарифы) → переносы между ЦФО → OPEX → выгрузки в Excel.
Ниже — функциональные блоки и их поток данных.
 1)	Загрузка данных из 1С и Excel 
1.1)	Принимает «универсальные отчёты» 1С (TXT/XLSX) и сопутствующие Excel-файлы: номенклатура, BOM/ресурсные спецификации, маршруты (routing), объёмы производства по месяцам, цены RM, справочники.
1.2)	Есть парсеры с толерантностью к кодировкам/разделителям и к «грязным» выгрузкам (полезно для TXT из 1С).
1.3)	На выходе — стейджинг-таблицы и нормализованные сущности (items, BOM, routings, prices, volumes, справочники ЦФО/элементов затрат).
2) Расчёт бюджета (на основании загруженных данных)
2.1)	Для производимой продукции: разворачивание BOM (рекурсивно, до листьев), умножение на объёмы (помесячно), применение цен на RM.
2.2)	Для работ/операций: материализация дерева маршрутов, часы/нормы, драйверы распределения косвенных.
2.3)	Результат укладывается в нормализованные таблицы бюджета (по CC × Element × Period), с атрибутами источника (load_id, sheet и т.п.).
3)	Загрузка бюджета OPEX (особенности)
3.1)	В системе есть отдельный «особенный» загрузчик OPEX: стейджинг без жёстких FK, маппинг по правилам (описание счета/статьи → элемент затрат), проверка «пропущенных» ЦФО/элементов, флаги «unmapped», «missing_cc», «bad_amount», «dup_candidate».
3.2)	Коммит в «чистую» таблицу бюджета OPEX с валидацией, чтобы дальше отчёт/своды были единообразны.
4)	Перенос затрат между подразделениями (внутренние распределения)
4.1)	Логика трансферов/переносов (внутризаводские услуги) между ЦФО: корректирует получателя/дарителя, чтобы аналитика расходов и тарифов была правдивой на уровне потребителей. 
4.2)	Используется в контурах: дорасчёт себестоимости, пересчёт тарифов, свод CC×Element.
5)	Расчёт тарифа на прямой персонал
5.1)	Считает ставку (час/смена/период) для прямого труда по ЦФО/участкам на базе объёма часов и фонда оплаты (в т.ч. после переносов).
5.2)	Тариф затем входит в калькуляцию производственных затрат и в итоговые бюджетные суммы.
6)	Вывод результатов в Excel
6.1)	Единые выгрузки (по слоям): срезы CC×Element×Period, отчёты по OPEX, по материалам, по труду, «контрольные» листы для ревью.
6.2)	Отдельно — служебные листы со статусами загрузок (load_id), логами/ошибками маппинга.

## Быстрый старт
1) Запустить `app_streamlit.py`.  
2) Перейти в **НСИ** → вкладка **Справочники**.  
3) Подготовить БД и загрузить MFCPRIM/CCG.  
4) Вкладка **Правила**: импорт `detail_rules`/`fallback_rules`.  
5) Вкладка **Просмотр деревьев** и **Проверка данных** для контроля качества.

## Где что
- `ui/ui_nsi_references.py` — страница НСИ (вкладки).
- `loaders/load_cost_structures.py` — MFCPRIM (elements) parser + upsert.
- `loaders/ccg_wru_loader.py` — CCG WRU (cost centers) parser + upsert.
- `loaders/rules_loader.py` — таблица правил, импорт из Excel, CRUD.
- `db/connection.py` — `normalize_db_path`, обвязка SQLite.

## Зачем docs/
- Перенос контекста между чатами и ZIP‑релизами.
- Консистентное онбординг‑описание и runbook.
