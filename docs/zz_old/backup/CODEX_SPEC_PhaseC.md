# VS Code — gpt-5-codex Task Spec (Phase C)

**Контекст:**  
Phase A дал единый слой `drivers/driver_values/cost_rates/fact_measures` и совместимые вьюхи.  
Phase B внедрил `cost_allocations`, `v_allocation_rule_effective`, lineage и первый E2E (LABOR_DIRECT на HOURS).  
Теперь переводим всё на новый слой и демонтируем старое без потери отчётности.

## Цели
1) Перевести все калькуляторы на чтение из **driver_values / cost_rates** (и новых иерархий).  
2) Заменить старые «широкие» таблицы совместимыми `VIEW` и **убрать мёртвый код/схему**.  
3) Расширить покрытие компонентов: `DEPR_OPR`, `OVH_LOG`, `OVH_ADM`, при необходимости другие (Facilities/AREA_SHARE и т.п.).  
4) Укрепить производительность: индексы, батчи, кэшируемые материализации.  
5) Собрать тест-пак: unit + интеграция + golden datasets (сравнение чисел 1:1).

## Ограничения
- SQLite (single-writer) — вставки батчами, короткие транзакции.  
- Неразрушающие миграции: сначала `VIEW`-совместимость, потом удаление.  
- Эталонные цифры (golden) для 2–3 месяцев по ключевым отчётам.

---

## Периметр работ и Deliverables

### 1) Миграция калькуляторов (на новые источники)
- Обновить все калькуляторы и сборки себестоимости, чтобы они читали:  
  - базы/показатели → из `driver_values` (HOURS, MATCOST, PAYROLL_OTHER, AREA_SHARE…)  
  - ставки/тарифы → из `cost_rates` (вместо `labor_cost_unit`, `opr_rates_snapshot`, `ovh_tariffs` напрямую)  
  - правила → через `v_allocation_rule_effective` (с поддержкой elem-групп и closure)
- Для каждого калькулятора: оставить временный флажок `use_legacy=false` и отчёт сравнения чисел vs legacy.

### 2) Совместимые `VIEW` и демонтаж
- Заменить старые широкие таблицы `*_cost_unit*`, `*_rates*` на `VIEW` поверх новых слоёв:  
  - `v_labor_cost_unit_total`, `v_opr_cost_unit_total`, `v_ovh_cost_unit` уже есть — довести до паритета.  
- После подтверждённого паритета:  
  - удалить «писатели» в эти таблицы (старые пайплайны),  
  - пометить сами физические таблицы к удалению (миграция vX+1) и оставить только `VIEW` (или алиасы).

### 3) Расширение компонент (DEPR_OPR, OVH_LOG, OVH_ADM, …)
- Добавить правила/ставки/базы для новых компонент:  
  - `DEPR_OPR`: использовать доли из `ovh_nodes/ovh_tariffs` или `cost_rates` (годовые доли → помесячная раскладка).  
  - `OVH_LOG`, `OVH_ADM`: определить `driver_code` (например, MATCOST/QTY/PAYROLL_OTHER/AREA_SHARE), завести правила по CC×elem-группам.  
- E2E прогон по каждой компоненте → записи в `cost_allocations` → попадание в `v_cogs_unit`.

### 4) Performance hardening
- Индексы:  
  - `driver_values(period, driver_code, scenario, set_id) WHERE value>0 OR is_explicit_zero=1` (partial)  
  - `cost_allocations(period, scenario, component_code)`  
  - `lineage_links(rule_id, run_id)`  
  - `rule_scope_resolved(rule_set_id, cc_leaf_id, elem_leaf_id)` (если материализовано)
- Батчи/транзакции: размер пачки для вставок в `cost_allocations` (напр., 5–20k строк).  
- Материализация «тяжёлых» вьюх: пред-вычислить `rule_scope_resolved` и (при необходимости) агрегаты для `v_cogs_unit`.  
- Кэширование активных наборов (`active_scenarios`, `active_rule_set`) в памяти процесса с TTL.

### 5) Тест-пак
- **Unit:** драйверные агрегаторы, ставки (rate = pool/base), выбор правила (specificity/priority).  
- **Integration:** полный прогон периода (Plan и Act) с проверкой реконсиляций (Σpools == Σalloc).  
- **Golden datasets:** фиксация эталонных результатов для 2–3 месяцев. Автотест: сравнение отчётов (новый слой) vs legacy на уровне сумм и unit-стоимости; допускаемая дельта = 0.

---

## Пошаговый план внедрения

### Sprint C1 — Перевод калькуляторов + Views
1) Переключить чтение калькуляторов на `driver_values/cost_rates` с флагом `use_legacy=false` (параллельный вывод в отчёт сравнения).  
2) Довести `VIEW`-совместимость (legacy имена/типы).  
3) Сравнить все ключевые отчёты за месяц M (golden). Исправить расхождения.  
**Выход:** отчёты за M совпадают 1:1.

### Sprint C2 — Компоненты DEPR_OPR, OVH_LOG, OVH_ADM
1) Настроить правила (rule_scope) по elem-группам и производственным CC.  
2) Добавить/загрузить драйверы (если нужны новые: QTY/AREA_SHARE).  
3) Прогнать E2E и пройти `v_recon_checks`.  
**Выход:** компоненты попали в `cogs_unit`, сверки = 0.

### Sprint C3 — Производительность и демонтаж
1) Добавить индексы, батчи; материализовать `rule_scope_resolved` (если нужно).  
2) Отключить старые писатели; оставить только `VIEW`-алиасы.  
3) Golden-сравнение за 3 месяца (вкл. «тяжёлый» месяц).  
**Выход:** стабильное время прогона и полное соответствие.

---

## Критерии приёмки (Exit Criteria Phase C)
- ✅ Все основные отчёты работают на новом слое с числовым паритетом (golden months = OK).  
- ✅ Старые таблицы/калькуляторы либо удалены, либо заменены на `VIEW`-алиасы; нет зависимостей на их «прошлые» писатели.  
- ✅ Компоненты `LABOR_DIRECT`, `DEPR_OPR`, `OVH_LOG`, `OVH_ADM` (и заявленные дополнительные) формируются через `cost_allocations` и видны в `v_cogs_unit`.  
- ✅ Реконсиляции `v_recon_checks` дают сумму дельт = 0 по всем компонентам/месяцам теста.  
- ✅ Тест-пак зелёный: unit, integration, golden; CI job прогоняет проверки.

---

## Подсказки по коду/файлам
- **Где менять:** `calc/*` калькуляторы, `db/schema.py` (миграции v8+), `calc/alloc_engine.py`, `ui/*` (минимально — если нужны новые фильтры).  
- **Что читать:** `v_allocation_rule_effective`, `driver_values`, `cost_rates`, `v_cogs_unit`, `v_recon_checks`.  
- **Стиль:** один каркас для всех компонент (различия — в `component_code` и `driver_code`), без разветвления «по типам».

---

## Роллаут & откат
- **Фича-флаги:** `use_new_layer`, `use_legacy_views_only`, `materialize_rules`.  
- **Откат:** оставить `VIEW`-алиасы и переключить флаги на legacy-чтение (до фикса).  
- **Мониторинг:** лог времени этапов (ETL/alloc/report), размер таблиц, счётчик «дельт ≠ 0» в `v_recon_checks`.

---

## Риски и меры
- **Расхождения чисел** → golden-сравнение на каждом спринте; lineage для трассировки.  
- **Производительность** → индексы/батчи/материализация; избегать N×recompute.  
- **Зависимости UI** → сохраняем схемы старых представлений через `VIEW` до финального отключения.
