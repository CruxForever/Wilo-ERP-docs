# Wilo-ERP

## Что это за система (как она устроена сейчас)
Wilo-ERP — это «мини-ERP» на Python + SQLite + Streamlit-UI, которая замыкает цикл: загрузка первички из 1С/Excel → нормализация → расчёты бюджета (материалы/операции/тарифы/overhead) → переносы между ЦФО → OPEX → выгрузки в Excel.

Ниже — функциональные блоки и их поток данных.

1) **Загрузка данных из 1С и Excel**  
- Принимает «универсальные отчёты» 1С (TXT/XLSX) и сопутствующие Excel-файлы: номенклатура, BOM/ресурсные спецификации, маршруты (routing), объёмы производства по месяцам, цены RM, справочники.  
- Парсеры толерантны к кодировкам/разделителям и «грязным» выгрузкам.  
- Результат — стейджинг-таблицы и нормализованные сущности (items, BOM, routings, prices, volumes, справочники ЦФО/элементов затрат).

2) **Расчёт бюджета (на основании загруженных данных)**  
- Для производимой продукции: разворачивание BOM (рекурсивно, до листьев), умножение на объёмы (помесячно), применение цен на RM.  
- Для работ/операций: материализация дерева маршрутов, часы/нормы, драйверы распределения косвенных.  
- Результат — нормализованные таблицы бюджета (по CC × Element × Period), с load_id, sheet и т.п.

3) **Загрузка бюджета OPEX**  
- Отдельный загрузчик OPEX: стейджинг без жёстких FK, маппинг по правилам (описание счета/статьи → элемент затрат), проверка «пропущенных» ЦФО/элементов, флаги `unmapped`, `missing_cc`, `bad_amount`, `dup_candidate`.  
- Коммит в «чистую» таблицу бюджета OPEX с валидацией.

4) **Перенос затрат между подразделениями (трансферы)**  
- Логика внутренних услуг: корректирует получателя/дарителя, чтобы аналитика расходов и тарифов была правдивой.  
- Используется для дорасчёта себестоимости, тарифов, свода CC×Element.

5) **Расчёт тарифа на прямой персонал**  
- Считает ставку (час/смена/период) для прямого труда по ЦФО/участкам на базе объёма часов и фонда оплаты (с учётом переносов).  
- Тариф входит в калькуляцию производственных затрат и бюджет.

6) **Расчёт тарифов оверхэдов (ОПР/ОХР)**  
- Таблица `ovh_tariffs` переведена в длинный формат: `(overhead_group, year, cost_type, share)`.  
- Типы: `scrap` (брак, от материалов), `depr_opr` (амортизация ОПР, от материалов), `log` (логистика, от материалов), `adm` (управленческие, от базы ЗП+ОПР).  
- В UI три вкладки: «Амортизация ОПР», «ОХР Логистика», «ОХР Управленческие». Есть кнопки «Рассчитать» (предпросмотр: матбаза, распределение, % доля, средний по заводу) и «Записать» (апсерт в `ovh_tariffs`).  
- Для пустых матбаз предлагается средний процент по заводу.  
- Массовый расчёт теперь принимает параметр `ovh_year`.

7) **Вывод результатов в Excel**  
- Единые выгрузки (по слоям): CC×Element×Period, отчёты по OPEX, материалы, труд, overhead, контрольные листы для ревью.  
- Служебные листы со статусами загрузок (load_id), логами/ошибками маппинга.

8) **Важно**: все расчёты в системе теперь параметризованы сценариями (price_scn, vol_scn). Любая функция материализации или отчёт должна вызываться с указанием сценария, иначе будут использованы настройки по умолчанию из active_scenarios.

9) **PPV**: Добавлен отчет по ценовому отклонению. поддерживает сценарий цен: бюджетная, текущая,... Выбор объемов для сравнения. Отчет формируется в соответствии с групповыми commodity group. Расширен справочник items

## Архитектура
- **Язык и СУБД**: Python 3.x, SQLite.  
- **UI**: Streamlit.  
- **Структура пакетов**:  
  - `calc` — пайплайны расчёта себестоимости, бюджета, тарифов, переносов, качества.  
  - `db` — подключение, схемы, запросы, ensure-функции.  
  - `loaders` — загрузка данных (CCG, MFCPRIM, BOM, маршруты, цены, персонал, OPEX).  
  - `ui` — интерфейс Streamlit: вкладки администрирования, загрузки, калькуляций, бюджетов, трансферов.  
  - `config` — настройки.  
  - `app` — инициализация БД.  

Статистика: **7 пакетов, 39 модулей, 251 функций, 13 классов**.

## База данных
- Таблицы: **35**, Вьюхи: **3**.  
- Ключевые сущности:  
  - `items`, `bom`, `routings` — НСИ продукции и маршрутов.  
  - `rm_prices`, `mo_prices_history` — цены материалов и услуг.  
  - `prod_budget`, `opex_budget`, `opex_staging` — бюджеты.  
  - `labor_rates`, `depr_rates_snapshot`, `opr_rates_snapshot` — ставки и снапшоты.  
  - `transfer_*` — правила и записи переносов.  
  - Вьюхи: `mo_last_price_current`, `personnel_yearly`, `personnel_yearly_effective`.  
- Полная схема в [DB_SCHEMA.md](DB_SCHEMA.md).

## Основные процессы
1. **Загрузка НСИ** — номенклатура, BOM, спецификации, маршруты, цены, ЦФО, элементы затрат.  
2. **Бюджет производства** — разворачивание BOM, умножение на объёмы, применение цен.  
3. **Бюджет OPEX** — загрузка через staging, маппинг по правилам, валидация, коммит.  
4. **Расчёт тарифов** — прямой персонал, амортизация, накладные (по ЦФО и годам).  
5. **Переносы** — внутренние распределения затрат и headcount.  
6. **Контроль качества** — проверки консистентности данных.  
7. **Отчётность** — выгрузки Excel по слоям (CC×Element×Period), контрольные листы, логи.

## Быстрый старт
1. Установить зависимости (Python 3.11+, pandas, numpy, openpyxl, streamlit).  
2. Запустить UI:  
   ```bash
   streamlit run ui/app_streamlit.py
   ```  
3. Вкладка **НСИ** — загрузить справочники (MFCPRIM, CCG).  
4. Вкладка **Правила** — импортировать detail_rules / fallback_rules.  
5. Вкладка **Калькуляции** — проверить BOM, маршруты, ставки.  
6. Вкладка **Бюджет** — загрузить prod_budget, opex_budget.  
7. Вкладка **Проверка данных** — прогнать quality-чекеры.  

## Документация
- [Project overview](PROJECT_OVERVIEW.md) — список пакетов, модулей и функций.  
- [Architecture summary](ARCHITECTURE_SUMMARY.md) — структура и статистика.  
- [Database schema](DB_SCHEMA.md) — SQL-DDL таблиц и вьюх.  
- [Data dictionary](DATA_DICTIONARY_CONDENSED.md) — конденсированный словарь данных.  
