# Runbook: Бюджет

## Почему это важно
Бюджет — ключевая часть производственного цикла: он задает целевые объемы, ставки и ограничения на весь плановый период. Подготовка бюджета начинается в августе, когда собираются исходные справочники и сценарии продаж, и завершается в декабре вместе с финализацией расчетов. От качества загрузки данных зависит прозрачность себестоимости, поэтому каждое действие фиксируем в runbook.

## Загрузка данных
Перед расчетом нужно очистить и заново наполнить мастер-данные, затем загрузить все входы для расчетов.

### Master Data → Справочники
Работаем последовательно по четырем вкладкам внутри раздела «Справочники».
![Master Data - Dim](../img/Master%20Data/Dim/Dim.png)

#### Путь к БД
- Откройте `Master Data → Справочники → Путь к БД`.
- Убедитесь, что путь к SQLite указан верно (можно поправить прямо в поле).
- Нажмите «Подготовить/обновить схему» — это создаст недостающие таблицы и приведет структуру к актуальной версии.
![Master Data - Dim](../img/Master%20Data/Dim/DB_Path.png)

#### Загрузка элементов
- На вкладке «Загрузка элементов» выберите лист MFCPRIM (по умолчанию `MFC_PRIM`) и загрузите свежий `MFCPRIM.xlsx`.
- После кнопки «Загрузить элементы» файл парсится, а таблицы `elem_nodes`/`elem_edges` перезаполняются.
- В конце проверьте статистику по узлам/связям; при ошибках лист/формат нужно исправить и повторить загрузку.
![Master Data - Dim - CEG](../img/Master%20Data/Dim/CEG_import.png)

#### Загрузка структуры МВЗ
- Во вкладке «Загрузка структуры МВЗ» требуется два файла: `CCG_WRU.xlsx` (иерархия групп) и `CC_list.xlsx` (листовые центры).
- После указания имени листа (например, `CCG_RU1`) нажмите «Загрузить структуру ЦФО (2 файла)».
- Система пробежит ensure_schema/ensure_cc_extra_columns, загрузит оба файла, посчитает статистику по `cc_nodes/cc_edges` и покажет пропущенные ребра. Все предупреждения (skipped_edges) нужно отработать до следующего шага.
![Master Data - Dim - CCG](../img/Master%20Data/Dim/CCG_import.png)

#### Обновление имен центров и групп затрат
- На вкладке «Обновление имен центров и групп затрат» загрузите Excel c колонками `cc_id` и `name`.
- Кнопка «Обновить список имен» применяет значения к `cc_nodes`. После подтверждения проверьте количество обновленных строк и убедитесь, что файл не содержит пустых значений.
![Master Data - Dim - CCG](../img/Master%20Data/Dim/CCG_update.png)

### Import Data → Данные для расчета
После того как справочники чистые, переходим к вкладке `Import Data` и последовательно отрабатываем каждый пункт меню.

#### Sales BU
- Выберите сценарий продаж (BG25_VOL, FC3_VOL, BG26_VOL и т.д.).
- Загрузите Excel с плановыми объемами производства и нажмите «Загрузить файл».
- После сообщения об успехе проверьте список месяцев и предупреждения о ненайденных `item_id`.
- При необходимости нажмите «Сформировать SFG BG»: система возьмёт объёмы выбранного FG-сценария, разложит BOM до полуфабрикатов и запишет результат в `prod_budget` (по умолчанию сценарий `<FG>_SFG`, значение можно изменить рядом с кнопкой).
- Новый сценарий с полуфабрикатами сразу доступен в просмотре бюджета, поэтому после генерации его можно выбрать вместе с исходным FG (см. раздел ниже).
![Master Data - Import - SalesBU](../img/Master%20Data/Import/10_Sales_BU.png)

#### Opex BU
- Через форму «OPEX Budget Loader» загрузите Excel (лист по умолчанию `INPUT`) и нажмите «Предпросмотр».
- Если данные корректны, отправьте их в staging (кнопка «Загрузить в staging») и дождитесь `load_id`.
- Просмотрите диагностику (отсутствующие CC, незамапленные элементы, подозрительные суммы). Исправьте файл при необходимости.
- Когда ошибок нет, нажмите «Залить в БД (opex_budget)» — таблица пополнится новыми данными за выбранный год.
![Master Data - Import - OpexBU](../img/Master%20Data/Import/20_Opex_BU.png)

#### Материалы
- Вкладка «Материалы» принимает TXT из 1С или Excel-шаблон `items.xlsx`.
- После загрузки просмотрите первые строки и нажмите «Загрузить» (формат определяется автоматически).
- При необходимости используйте блок «Флаг производимой номенклатуры», чтобы переключить поле `is_produced` для конкретного `item_id`.
![Master Data - Import - Items](../img/Master%20Data/Import/30_items.png)

#### BOM: General
- Укажите дату `valid_from` (например, `2026-01-01`) и загрузите файл со спецификациями.
- Кнопка «Загрузить и upsert (Specs)» запускает staging и upsert в `bom_specs`.
- В описании выводится `load_id` — зафиксируйте его, чтобы в случае ошибки легко найти загрузку.
![Master Data - Import - BomG](../img/Master%20Data/Import/40_Bomg.png)

#### BOM: Compon
- Заполните `spec_valid_from`, загрузите файл с компонентами и выполните «Загрузить и upsert (Components)».
- После апдейта можно в том же блоке запустить «Материализовать BOM»: введите `product_id` (оставьте пустым для всех) и дождитесь сообщения об успешной материализации.
![Master Data - Import - BomC](../img/Master%20Data/Import/45_Bomc.png)

#### Ставки (Тарифы)
- Интерфейс «Ставки (Тарифы)» обслуживает `cost_rates`. Выберите компонент (DL/OPR/DEPR), сценарий, валюту и единицу измерения.
- Загрузите Excel с тарифами, проверьте автоопределение колонок (CostCenter, WorkCenter, месяцы, годовой тариф) и при необходимости поправьте.
- Нажмите «Нормализовать» для формирования лонг-формата и посмотрите статистику/предпросмотр.
- После валидации (блок «Проверки») нажмите «Загрузить в cost_rates» — система присвоит `run_id` и заапсертит ставки.
![Master Data - Import - D-rates](../img/Master%20Data/Import/50_Rates.png)

#### Цены R-mat
- Загрузите файл с ценами сырья (поддерживаются XLSX/XLS/XLSM). Скрипт приведет текстовые значения, цены и даты к единому виду.
- Проверьте предпросмотр (первые 100 строк). Если в файле нет колонки с датой, заполните поле «Дата начала действия».
- Укажите `load_id` (опционально, для трассировки) и нажмите «Загрузить цены» — данные попадут в таблицу цен на сырье.
![Master Data - Import - Prices](../img/Master%20Data/Import/60_prices.png)

#### SC-add Value
- Подготовьте Excel с тарифами цехов/оборудования/добавленной стоимости.
- Загрузите файл, задайте год действия и нажмите «Загрузить тарифы». Обработчик вызовет `load_ovh_tariffs` и запишет строки за выбранный год.
![Master Data - Import - InD-rates](../img/Master%20Data/Import/55_SC_rates.png)

#### Загрузка рутингов
- Сначала запустите диагностику («Построить диагностику») — она выявит операции без департамента, нулевые нормы, дубли `seq`.
- При наличии рекомендаций используйте кнопку «Применить автоисправления» для заполнения департаментов.
- После очистки нажмите «Загрузить рутинги», выберите файл (CSV/Excel) и дождитесь ответа `upsert_routings`.
![Master Data - Import - Rout](../img/Master%20Data/Import/70_routings.png)

#### МехОбработка
- Укажите поставщика, даты действия, источник и решите, нужно ли автоматически пересчитывать `mo_cost_unit`.
- Загрузите файл с расценками мехобработки, выберите лист и нажмите предпросмотр — отобразятся расценки и проблемные строки (не найденные `item_id`/цены).
- Нажмите «Загрузить прайс МО» (при необходимости с авто-материализацией). Все шаги работают через `load_mo_prices`, поэтому сохраняйте логи по sheet/source.
![Master Data - Import - Sub-C](../img/Master%20Data/Import/80_Sub_c.png)

#### Персонал
- Укажите год и посмотрите текущие записи `personnel_monthly` (таблица справа покажет существующие строки).
- Загрузите Excel по шаблону `110_HC_2026.xlsx`, при необходимости отметьте «Очистить год».
- По кнопке «Загрузить» данные запишутся в БД, появится предпросмотр и статистика. Ниже можно проверить агрегированные значения в `personnel_yearly`.
![Master Data - Import - FTE](../img/Master%20Data/Import/90_HC_FTE.png)

## Расчет
Расчет выполняется в `Costing Run → Materialize`. План действий:
- На вкладке `Materialize` по очереди нажмите «Materialize: Materials», «Materialize: Direct (routing)» и «Materialize: Indirect (OVH)». Это обновит плоские таблицы BOM, операции и накладные расходы.
- Каждый запуск показывает количество строк и время — фиксируйте их в журнале, чтобы отслеживать аномалии.

## Просмотр результата
- Перейдите в вкладку `Budget`. Выберите один или несколько сценариев объёмов (можно отметить FG и SFG одновременно), набор месяцев, год ставок и ценовой сценарий, затем нажмите «Пересобрать предпросмотр». После выполнения доступна таблица в UI и кнопка скачивания Excel.
- В предпросмотре и Excel присутствуют дополнительные колонки `Routing group` и `Overhead group` из справочника items — их удобно использовать для проверки связки маршрутов и накладных групп.
- Для точечной проверки используйте `Cost Tree`: выберите нужную ветку (CC/Element) и убедитесь, что рассчитанные ставки/объемы попали в дерево.
- При обнаружении расхождений возвращайтесь к соответствующему пункту загрузки, исправляйте источник и повторяйте расчет/просмотр.
