# Runbook: Отчетность (Budget tab)

## Назначение
Блок `Budget` в приложении скрывает сразу несколько отчетов:
1. сводный Production Budget;
2. вариант с KTL-разбивкой;
3. аналитика PPV (Price Purchase Variance);
4. конструктор/просмотр MFC Report.

Эта инструкция помогает быстро получить выгрузки и понимать, какие параметры влияют на результат.

### Предварительные условия
- Обновлена схема БД и выбран актуальный путь в сайдбаре.
- Загружены объемы (`prod_budget`), цены (`price_scenarios`), ставки (cost_rates/ovh) и выполнена материализация (см. runbook по бюджету).
- Для PPV должны существовать минимум три ценовых сценария, для MFC Report — заготовленные `mfc_report_defs`.

---

## 1. Production Budget (вкладка «Сводный обзор»)
1. Откройте `Budget → вкладка «Сводный обзор (Просмотр/пересборка)»`.
2. Выберите сценарий продаж (`prod_budget.scenario`) и диапазон месяцев (по умолчанию берется весь год).
3. Укажите год ставок (`list_rate_years`) и ценовой сценарий (`list_price_scenarios`).
4. Нажмите **«Пересобрать предпросмотр»**. После расчета отобразятся:
   - таблицы Total / Routers / BOM и т.д.;
   - краткий свод по суммам (материалы, труд, ОПР, амортизация, scrap и пр.).
5. Для финальной выгрузки нажмите **«Пересобрать Excel»**, дождитесь сообщения об успехе и воспользуйтесь кнопкой **«Скачать Production_Budget.xlsx»**.
6. Если нужно сбросить промежуточные данные, используйте кнопку **«Очистить предпросмотр»**.

> Совет: параметр `v_bom_costs_scenario` влияет на ставки в расчете — контролируйте, чтобы выбранный ценовой сценарий соответствовал загруженным данным.

---

## 2. Production Budget KTL (вкладка «BudgetKTL»)
1. Перейдите на вкладку **BudgetKTL**.
2. Повторите шаги из предыдущего раздела: выберите сценарий продаж, месяцы, год ставок и ценовой сценарий.
3. Нажмите **«Пересобрать предпросмотр»** — в отчете появятся дополнительные строки по KTL: труд/ОПР/амортизация в разрезе KTL-каналов.
4. Для выгрузки используйте кнопки **«Пересобрать Excel»** и **«Скачать Production_Budget_KTL.xlsx»**.

> Отличие: параметр `ktl_split=True` разбивает суммы по трудовым компонентам (trudktf, oprktf, amortktf). Без актуальных ставок в cost_rates эта вкладка вернет пустые блоки.

---

## 3. PPV (Price Purchase Variance)
1. Откройте вкладку **PPV**.
2. Выберите:
   - три ценовых сценария для сравнения (S1, S2, S3);
   - объемный сценарий (`prod_budget`);
   - опцию **«Исключить новые/retired позиции»**, если нужен «чистый» эффект цены.
3. Нажмите **«Рассчитать PPV»**. Появятся таблицы:
   - S1 vs S2 по группам материалов (CG);
   - S2 vs S3 по тем же CG;
   - RAW-данные в раскрывающемся блоке.
4. Скачайте Excel (**PPV_<S1>_<S2>_<S3>_<vol>.xlsx**) через кнопку «Скачать Excel».

> Если таблицы пустые — проверьте, что оба сценария существуют в `price_scenarios`, а объемный сценарий содержит строки в `prod_budget`.

---

## 4. MFC Report
1. Перейдите во вкладку **MFC_report**.
2. В выпадающем списке **Report ID** выберите нужную настройку (берется из `mfc_report_defs`).
3. Нажмите **«Перестроить отчет»**. На экране появится собранная форма.
4. Скачайте Excel-файл (`<report_id>.xlsx`) через кнопку **«Скачать Excel»**.

> Настройки строки/колонки отчета задаются заранее в `mfc_report_defs` и `mfc_report_lines`. Если список пуст, сначала загрузите шаблон через админ-инструменты NSI.

---

## Частые вопросы
- **Отчет пустой или кнопка неактивна.** Убедитесь, что предварительные данные (prod_budget, price_scenarios, cost_rates) загружены и материализация выполнена.
- **Не скачивается Excel.** После пересборки всегда дожидайтесь зеленого уведомления, затем используйте кнопку скачивания; в случае ошибки очистите предпросмотр.
- **Как поменять год по умолчанию?** Год и сценарии подтягиваются из БД. Обновите соответствующие таблицы и повторите загрузку.
